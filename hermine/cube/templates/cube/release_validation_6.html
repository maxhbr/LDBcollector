<!--
SPDX-FileCopyrightText: 2022 Martin Delabre <gitlab.com/delabre.martin>

SPDX-License-Identifier: AGPL-3.0-only
-->

{% extends "cube/cube.html" %}
{% load cube_tags %}

{% block title %}{{ object.product.name }} {{object.release_number}}{% endblock %}
{% block breadcrumbs %}
  <ul>
    <li><a href="{% url 'cube:dashboard' %}">Hermine</a></li>
    <li><a href="{% url 'cube:product_detail' object.product.id %}">{{ object.product.name }}</a></li>
    <li>{{object.release_number}}</li>
    <li>Validation</li>
  </ul>
{% endblock %}
{% block herozone %}
  <div class="hero-body">
    <p class="title">Release: {{object.release_number}}</p>
  </div>
{% endblock %}
{% block content %}

  {% include "cube/includes/release_tabs.html" with active_tab="validation" %}
  <div class="tabs is-toggle is-fullwidth">
    <ul>
      <li>
        <a href="{% url "cube:release_validation_step_1" object.id %}">
          <span class="icon is-small">
            {% if object.valid_step < 1 %}<i class="fas fa-times" aria-hidden="true"></i>
            {% else %}<i class="fas fa-check" aria-hidden="true"></i>
            {% endif %}
          </span>
          <span>Valid SPDX</span>
        </a>
      </li>
      <li>
        <a href="{% url "cube:release_validation_step_2" object.id %}">
          <span class="icon is-small">
            {% if object.valid_step < 2 %}<i class="fas fa-times" aria-hidden="true"></i>
            {% else %}<i class="fas fa-check" aria-hidden="true"></i>
            {% endif %}
          </span>
          <span>Confirm ANDs</span>
        </a>
      </li>
      <li>
        <a href="{% url "cube:release_validation_step_3" object.id %}">
          <span class="icon is-small">
            {% if object.valid_step < 3 %}<i class="fas fa-times" aria-hidden="true"></i>
            {% else %}<i class="fas fa-check" aria-hidden="true"></i>
            {% endif %}
          </span>
          <span>Define exploitations</span>
        </a>
      </li>
      <li>
        <a href="{% url "cube:release_validation_step_4" object.id %}">
          <span class="icon is-small">
            {% if object.valid_step < 4 %}<i class="fas fa-times" aria-hidden="true"></i>
            {% else %}<i class="fas fa-check" aria-hidden="true"></i>
            {% endif %}
          </span>
          <span>Licence choices</span>
        </a>
      </li>
      <li>
        <a href="{% url "cube:release_validation_step_5" object.id %}">
          <span class="icon is-small">
            {% if release.valid_step < 5 %}<i class="fas fa-times" aria-hidden="true"></i>
            {% else %}<i class="fas fa-check" aria-hidden="true"></i>
            {% endif %}
          </span>
          <span>Check policy</span>
        </a>
      </li>
      <li class="is-active">
        <a>
          <span class="icon is-small">
            {% if release.valid_step < 6 %}<i class="fas fa-times" aria-hidden="true"></i>
            {% else %}<i class="fas fa-check" aria-hidden="true"></i>
            {% endif %}
          </span>
          <span>Check compatibility</span>
        </a>
      </li>
    </ul>
  </div>
  {% if object.valid_step < 6 %}
    <p>You have completed  {{ object.valid_step }} out of 6 validation steps</p>
  {% else %}
    <article class="message is-success is-large">
      <div class="message-header">
        <p>Finished</p>
      </div>
      <div class="message-body">
        <span class="icon has-text-success"><i class="fas fa-check-square"></i></span>
        That's it ! All your usages are valid, qualified, and checked.
        You can now proceed to the check of your obligations.
      </div>
    </article>
    <hr />
  {% endif %}


  <h4 class="title is-4">Step 6 - Check licenses compatibility</h4>

  {% if release.outbound_licenses.count %}
    <p>
      Exploitation licenses{{ release.outbound_licenses.count|pluralize }} :
      {% for lic in release.outbound_licenses.all %}
        <a href="{% url "cube:license_detail" lic.pk %}">{{ lic.long_name }}</a>
        {% if not forloop.last %}, {% endif %}
      {% endfor %}
    </p>
  {% else %}
    <p>
      No exploitation licenses selected. This may be a correct choice if the release is not distributed,
      or for most proprietary licenses.
    </p>
  {% endif %}

  {% if perms.cube.change_release %}
    <a class="button mb-4" href="{% url "cube:release_update" release.pk %}?from={{ request.path|urlencode }}">Edit release</a>
  {% endif %}

  {% if incompatible_usages or incompatible_licenses %}
    <article class="message is-danger">
      <div class="message-header">
        <p>Some component licenses are not compatible with exploitation licenses of the release.</p>
      </div>
      <div class="message-body">
        <p>
          {{ incompatible_usages|length }} component{{ incompatible_usages|length|pluralize }}
          use{{ incompatible_usages|length|pluralize:"s," }} licenses that are not compatible with exploitation licenses of the release
          ({{ incompatible_licenses|length }} incompatible license{{ incompatible_licenses|length|pluralize }}
          in total).
        </p>
      </div>
    </article>
    <table class="table is-bordered is-striped">
      <thead>
        <tr>
          <th>Component</th>
          <th>Exploitation</th>
          <th>Linking</th>
          <th>Licenses</th>
        </tr>
      </thead>
      <tbody>
        {% for usage in incompatible_usages %}
          <tr>
            <td>
              {% if perms.cube.view_version %}
                <a href="{% url "cube:component_detail" usage.version.component.id %}">{{ usage.version }}</a>
              {% else %}
                {{ usage.version }}
              {% endif %}
            </td>
            <td>{{ usage.get_exploitation_display }}</td>
            <td>{{ usage.get_linking_display }}</td>
            <td>
              {% for lic in usage.licenses_chosen.all %}
                {% if perms.cube.view_license %}
                  <a href="{% url "cube:license_detail" lic.pk %}">
                    <span class="tag {{ lic|licenseAllowedCSS }}">
                      {{ lic.spdx_id }}
                    </span>
                  </a>
                {% else %}
                  <span class="tag {{ lic|licenseAllowedCSS }}">
                    {{ lic.spdx_id }}
                  </span>
                {% endif %}
              {% endfor %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  {% if not incompatible_usages and not incompatible_licenses %}
    {% if release.valid_step > 5 %}
      <article class="message is-success">
        <div class="message-header">
          <p>Success</p>
        </div>
        <div class="message-body">
          <span class="icon has-text-success"><i class="fas fa-check-square"></i></span> All component licenses are compatible with the choice of exploitation licenses.
        </div>
      </article>
    {% else %}
      <article class="message is-info">
        <div class="message-header">
          <p>Waiting for previous steps</p>
        </div>
        <div class="message-body">
          Validate previous steps to check all licenses against policy.
        </div>
      </article>
    {% endif %}
  {% endif %}
{% endblock %}
