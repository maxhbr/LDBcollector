# Use this file to launch a production instance of Hermine
#
# Do not edit this file directly for configuration, instead use the .env file
# to set the environment variables.
#
# For details on the different profiles, see the Install section in the doc.

version: '3.9'

services:
  db:
    image: postgres
    volumes:
      - db_volume:/var/lib/postgresql/data
    environment:
      - POSTGRES_NAME=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    networks:
      hermine_net:
  django:
    build:
      context: .
    volumes:
      - static_volume:/opt/hermine/static
      - $PWD/docker/shared.json:/opt/hermine/shared.json
    environment:
      # hard-coded defaults for docker-compose
      - SUPERUSER=admin
      - PASSWORD=admin
      - STATIC_ROOT=/opt/hermine/static
      - DJANGO_PORT=8080
      - POSTGRES_NAME=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5432
      # must be set in .env
      - SECRET=${HERMINE_SECRET:?err}
      - HOST=${HERMINE_HOST:-localhost}
      # can be overridden in .env
      - PRODUCTION=${HERMINE_PRODUCTION:-True}
      - DJANGO_THREADS=${HERMINE_DJANGO_THREADS:-${THREADS}} # Defaults to number of cores
      - CSRF_TRUSTED_ORIGINS=${HERMINE_CSRF_TRUSTED_ORIGINS:-${CSRF_TRUSTED_ORIGINS}}
      - ENABLE_PROFILING=${HERMINE_ENABLE_PROFILING:-${HERMINE_PROFILING:-False}}
      - MAX_UPLOAD_SIZE=${HERMINE_MAX_UPLOAD_SIZE}
      - TRUST_PROXY_HEADERS=${HERMINE_TRUST_PROXY_HEADERS:-True}
    links:
      - db
    networks:
      hermine_net:


  local_caddy:
    image: caddy
    volumes:
      - caddy_data:/data
      - caddy_config:/config
      - $PWD/docker/Caddyfile.localhost:/etc/caddy/Caddyfile
      - static_volume:/var/www/static
    environment:
      - PORT=${PORT:-8000}
    links:
      - django
    networks:
      hermine_net:
    ports:
      - "${PORT:-8000}:${PORT:-8000}"
    profiles: ["localhost"]


  web_https:
    image: caddy
    volumes:
      - caddy_data:/data
      - caddy_config:/config
      - $PWD/docker/Caddyfile:/etc/caddy/Caddyfile
      - static_volume:/var/www/static
    environment:
      - HOST=${HERMINE_HOST:-localhost}
      - DJANGO_PORT=8080
    links:
      - django
    networks:
      hermine_net:
    ports:
      - "443:443"
      - "80:80"
    profiles: ["https"]

networks:
  hermine_net:
volumes:
  db_volume:
  static_volume:
  caddy_data:
  caddy_config:
