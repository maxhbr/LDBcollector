Adapted from 1995 public domain C code 