reimplement from scratch to avoid GPL