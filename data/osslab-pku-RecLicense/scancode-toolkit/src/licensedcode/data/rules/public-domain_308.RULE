(Mostly) portable public-domain implementation