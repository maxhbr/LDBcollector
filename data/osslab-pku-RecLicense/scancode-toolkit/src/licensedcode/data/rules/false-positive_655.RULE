a lot of GPL-only code duplication