<!---  
SPDX-FileCopyrightText: 2022 Martin Delabre <gitlab.com/delabre.martin>
SPDX-FileCopyrightText: 2022 Hermine team <hermine@inno3.fr> 
SPDX-License-Identifier: CC-BY-4.0
-->

# REST API

Hermine's API uses the [Djano REST](https://www.django-rest-framework.org/) framework.

## Authentication

Authentication is handled through a Token system.
Make a POST request on 'api/token-auth/' with the fields 'username' and 'password' in a form-data.
This will give you a response like 


```json
{
    "token": "1273e3f6XXXXXXXXXXXXXXXX71209ac3bf29"
}
```


You can make any API call with this token given in a HTTP Header:  
`"Authorization" : "Token 1273e3f6XXXXXXXXXXXXXXXX71209ac3bf29"`.

In Python, using [requests](https://docs.python-requests.org/en/latest/),  it would look like:

```python
import requests

url = 'http://127.0.0.1:8080/releases/'
headers = {'Authorization': 'Token 1273e3f6XXXXXXXXXXXXXXXX71209ac3bf29'}
r = requests.get(url, headers=headers)
```

## API endpoints for Models


API endpoint for each class is accessible through '/api/<str:class_name>'. 

A detail view for an instance of a class can be found at '/api/<str:class_name>/<int:instance_id>'.

More information about API endpoints parameters can be found in the Views page.


## Uploading a BOM file

### ORT Evaluated model 

```{py:function} PUT /api/upload_ort/

Adds the content of the SBOM as EvaluatedModel to a given release

:param int release_id: the id of the release the BOM will be added to
:param json_file ort_file the evaluated-model.json file generated by ORT 
:return: the status of the upload
```


### SPDX file 


```{py:function} PUT /api/upload_spdx/

Adds the content of the SBOM as SPDX to a given release

:param int release_id: the id of the release the BOM will be added to
:param yaml_file spdx_file A yaml-SPDX BOM  
:return: the status of the upload
```

## Checking the validation steps

The validation process of a release is divided in 4 steps. You need to complete them in the right order.

When you encounter a result that does not fit requirements to go to next step, you'll need to make the appropriate work inside Hermine UI.

Every endpoint has a "valid" field that is set to True if every action that should be done has been done, and False otherwise.


### Step 1


```{py:function} GET api/releases/<int:release_id>/validation-1/

Adds the content of the SBOM as SPDX to a given release

:param int release_id: the id of the release the BOM will be added to
:return: the status of the upload
```

Can be found at 'api/releases/<int:release_id>/validation-1/'

API endpoint that allows to know if there are Unnormalised Usages.

The response is a dictionnary with the following fields :

unnormalised_usages
    An array of usage objects for which no license expression has been expressed.
 

### Step 2

Can be found at 'api/releases/<int:release_id>/validation-2/'

API endpoint that allows to know if there are Licenses that have not been checked by the legal team so far. 

The response is a dictionnary with the following fields :

licenses_to_check
    An array of license objects that are considered as "grey" and therefore need a manual check.

licenses_to_create
    An array of licenses that need to be created in hermine's database.


### Step 2 bis

Not implemented yet


### Step 3

Can be found at 'api/releases/<int:release_id>/validation-3/'

API endpoint that allows to know if there are complex license expressions in usages of this release.

A complex license expression is an expression with more than one License expressed in it.

A choice has to be made, either by keeping the whole expression either by picking the chosen licenses in the expression.

The response is a dictionnary with the following fields :

to_resolve
    An array of usages linked to a version that either has a complex "corrected_license" eother a "spdx_valid_license_expr" field, and for which no explicit choice as been made.
    To make a choice, click on "choose expression" in hermine UI. Pick the desired scope, type the actual expression you'll want to use for this component, and enter an explanation for your choice.
    This will create a UsageChoice object that is linked to the Usage object.

resolved
    An array of usages linked to a version hat either has a complex "corrected_license" eother a "spdx_valid_license_expr" field, and for which an explicit choice as been made.

### Step 4

Can be found at 'api/releases/<int:release_id>/validation-4/'
API endpoint that allows to know if there are Usages of unnacepted licenes in this release.
In this case, you must set relevant derogations in Hermine UI.

The response is a dictionnary with the following fields :

usages_lic_red
    An array of usages containing a license that has been marked as "red" by the legal team.

usages_lic_orange
    An array of usages containing a license that has been marked as "orange" by the legal team, which means that this license can sometimes be accepted depending on the context.

usages_lic_grey
    An array of usages containing a license that still has to be reviewed by the legal team.

involved_lic
    An array containing all the licenses that are red, orange or grey and that need a derogation for this release.

derogations
    An array of the derogations that has been made.
    
## Example


An example
```bash
  - run : "curl -X PUT https://chantier.hermine-foss.org/api/upload_ort/ -H 'Authorization: Token ${{ secrets.HERMINE_TOKEN }}' -F 'ort_file=@.tortellini/out/evaluated-model.json' -F 'release_id=1' --silent"
              if: ${{ success() }}
            - run : "curl https://chantier.hermine-foss.org/api/releases/1/validation-1/ -H 'Authorization: Token ${{ secrets.HERMINE_TOKEN }}' --output .hermine/validation-1.json --silent"
              if: ${{ success() }}
            - run : "curl https://chantier.hermine-foss.org/api/releases/1/validation-2/ -H 'Authorization: Token ${{ secrets.HERMINE_TOKEN }}' --output .hermine/validation-2.json --silent"
              if: ${{ success() }}
            - run : "curl https://chantier.hermine-foss.org/api/releases/1/validation-3/ -H 'Authorization: Token ${{ secrets.HERMINE_TOKEN }}' --output .hermine/validation-3.json --silent"
              if: ${{ success() }}
            - run : "curl https://chantier.hermine-foss.org/api/releases/1/validation-4/ -H 'Authorization: Token ${{ secrets.HERMINE_TOKEN }}' --output .hermine/validation-4.json --silent"
              if: ${{ success() }}
            - uses: actions/upload-artifact@v2
```
    
