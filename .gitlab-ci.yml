# SPDX-FileCopyrightText: 2021 Hermine-team <hermine@inno3.fr>
# SPDX-FileCopyrightText: 2022 Martin Delabre <gitlab.com/delabre.martin>
#
# SPDX-License-Identifier: CC0-1.0

image: python:3.8-alpine

tests:
  stage: test
  rules:
  - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  script:
  - apk --no-cache add curl
  - apk --no-cache add build-base libffi-dev postgresql-dev python3-dev openssl-dev cargo
  - pip install --upgrade pip
  - curl -sSL https://install.python-poetry.org | python -
  # Add Poetry to path:
  - export PATH="/root/.local/bin:$PATH"
  - poetry about
  - poetry install
  - cp hermine/hermine/mysecrets.default.py hermine/hermine/mysecrets.py
  - cd hermine
  - poetry run python manage.py test

pages:
  stage: deploy
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
  script:
  - apk --no-cache add curl
  - apk --no-cache add build-base libffi-dev postgresql-dev python3-dev openssl-dev cargo
  - pip install --upgrade pip
  - curl -sSL https://install.python-poetry.org | python -
  # Add Poetry to path:
  - export PATH="/root/.local/bin:$PATH"
  - poetry about
  - poetry install
  - cp hermine/hermine/mysecrets.default.py hermine/hermine/mysecrets.py
  - poetry run sphinx-build -b html docs/source docs/build/html
  - mkdir public
  - cp -r docs/build/html/* public/
  artifacts:
    paths:
    - public

variables:
  DOCKER_DRIVER: overlay2
