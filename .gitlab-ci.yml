# SPDX-FileCopyrightText: 2021 Hermine-team <hermine@inno3.fr>
# SPDX-FileCopyrightText: 2022 Martin Delabre <gitlab.com/delabre.martin>
#
# SPDX-License-Identifier: CC0-1.0

image: python:3.8-alpine

pages:
  stage: deploy
  
  script:
  - apk --no-cache add curl
  - apk --no-cache add build-base postgresql-dev python3-dev
  - curl -sSL https://install.python-poetry.org | python - ; cat poetry-installer-error*
  # Add Poetry to path:
  - export PATH="/root/.local/bin:$PATH"
  - poetry about
  - poetry install
  - cd hermine
  - cp hermine/mysecrets.default.py hermine/mysecrets.py
  - poetry run python manage.py makemigrations
  - poetry run python manage.py migrate
  - cd ..
  - poetry run sphinx-build -b html docs/source docs/build/html
  - mkdir public
  - cp -r docs/build/html/* public/

  artifacts:
    paths:
    - public
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH

variables:
  DOCKER_DRIVER: overlay2
# dco:
#   image: christophebedard/dco-check:latest
#   rules:
#     - if: $CI_MERGE_REQUEST_ID
#     - if: $CI_EXTERNAL_PULL_REQUEST_IID
#     - if: $CI_COMMIT_BRANCH == 'master'
#   script:
#     - pip3 install -U dco-check
#     - dco-check
